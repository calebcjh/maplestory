<html>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <head>
    <script src="octopus.js"></script>
    <script src='https://cdn.plot.ly/plotly-3.1.0.min.js'></script>
    <script>
      function processTapsResults(result) {
        const tickvals = Array.from({length: result.distribution.length + 1}, (_, i) => i);
        const ticktext = Array.from({length: result.distribution.length + 1},
            (_, i) => i == 
                result.distribution.length ? 
                'fail' :
                (result.distribution.length - i - 1).toString());
        const values = result.distribution.slice(0).reverse();
        values.push(result.fail);

        if (values.length < 16) {
          return [tickvals, ticktext, values];
        }

        const bucketSize = Math.ceil(values.length / 15);
        const remainder = (values.length - 1) % bucketSize;
        const newTicktext = [], newValues = [];

        if (remainder) {
          newTicktext.push(ticktext.slice(0, remainder).reduce((a, c) => {
            return {
              min: Math.min(c, a.min),
              max: Math.max(c, a.max)
            };
          }, {
            min: Infinity,
            max: -Infinity
          }));
          newValues.push(values.slice(0, remainder).reduce((a, b) => a + b, 0));
        }

        for (let i = remainder; i < values.length - 1; i+= bucketSize) {
          newTicktext.push(ticktext.slice(i, i + bucketSize).reduce((a, c) => {
            return {
              min: Math.min(c, a.min),
              max: Math.max(c, a.max)
            };
          }, {
            min: Infinity,
            max: -Infinity
          }));
          newValues.push(values.slice(i, i + bucketSize).reduce((a, b) => a + b, 0));
        }

        newTicktext.push(ticktext[ticktext.length - 1]);
        newValues.push(values[values.length - 1]);

        const newTickvals = Array.from({length: newValues.length}, (_, i) => i);

        return [newTickvals, newTicktext.map(p => p.max ? p.min == p.max ? p.min : `${p.min} - ${p.max}` : p), newValues];
      }

      window.addEventListener('load', () => {
        document.getElementById('go').addEventListener('click', () => {
          const level = parseInt(document.getElementById('lvl').value);
          const target = parseInt(document.getElementById('target').value);
          const taps = parseInt(document.getElementById('taps').value);

          const levelDist = genLvlsDist(level, taps, target);
          Plotly.newPlot('levelDist', [{
            x: ['', 1, 2, 3, 4, 5, 6, 7, 8, 9],
            y: levelDist,
            type: 'bar'
          }], {
            width: 400,
            height: 350,
            xaxis: {title: {text: 'level'}}
          });
          const reward = expectedRewards(levelDist);
          document.getElementById('frag').innerHTML = Math.round(reward.frag * 100) / 100;
          document.getElementById('erda').innerHTML = Math.round(reward.erda * 100) / 100;
          document.getElementById('exp').innerHTML = Math.round(reward.exp * 100) / 100;

          const [tickvals, ticktext, values] = processTapsResults(genTapsDist(level, taps, target));
          Plotly.newPlot('tapsDist', [{
            x: tickvals,
            y: values,
            type: 'bar'
          }], {
            width: 400,
            height: 350,
            xaxis: {
              title: {text: 'taps remaining'},
              tickvals: tickvals,
              ticktext: ticktext,
              tickmode: 'array'
            }
          });
        });
      });
    </script>
    <style>
      body, input, button {
        font-family: monospace;
      }
      body {
        align-items: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin: 0;
        padding: 0;
        width: 100%;
      }
      span {
        display: inline-block;
        margin: 0 5px 5px 0;
        text-align: right;
        width: 150px;
      }
      input {
        width: 50px;
      }
      button {
        text-align: center;
        width: 205px;
      }
      div#contents {
        padding: 20px 72.5px 0 72.5px;
        width: 205px;
      }
      b {
        display: inline-block;
        height: 30px;
        margin-top: -8px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div id="contents">
      <span>Current Level:</span><input id="lvl" type="number" min="1" max="9" value="1"><br>
      <span>Target Level:</span><input id="target" type="number" min="1" max="9" value="9"><br>
      <span>Taps remaining:</span><input id="taps" type="number" max="100" value="100"><br>
      <button id="go">Should I Tap My Octopus?</button><br>
    </div>
    <div id="rewards">
      <b id="frag">?</b><img src="https://media.maplestorywiki.net/yetidb/Etc_Sol_Erda_Fragment_%28Full_Size%29.png" style="height: 30px" />
      <b id="erda">?</b><img src="https://media.maplestorywiki.net/yetidb/Use_Sol_Erda.png"  style="height: 25px; margin: 2.5px" />
      <b id="exp">?</b><img src="https://pub-37581592c5a045f3ad8b1881608a2769.r2.dev/images%2Fitems%2Fuse%2Fadvanced-exp-ticket.png" style="height: 20px; margin: 5px" />
    </div>
    <div id="levelDist"></div>
    <div id="tapsDist"></div>
  </body>
</html>
